!function(i,t){"use strict";i.gmailInitAndOpen=function(a){if(i.__GMAIL_UI__){i.gmailOpenInbox?i.gmailOpenInbox():t("#gmail-inbox-modal").modal("show");return}i.__GMAIL_UI__=!0;var e=(a=a||i.GMAIL_CFG||{}).URL_LIST||"",l=a.URL_SYNC||"",n=a.URL_DETAIL||"";if(!e||!l||!n){console.error("GMAIL_CFG belum lengkap",a),i.Swal&&Swal.fire("Error","Konfigurasi Gmail belum lengkap.","error");return}var s=null,o=!1,r=null;function m(i){return(i||"").toString().replace(/[&<>"']/g,function(i){return({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[i]})}function c(){var i=document.getElementById("gmail-toast");i&&(i.classList.remove("show"),clearTimeout(r),r=setTimeout(function(){try{i.style.display="none"}catch(t){}},200))}function d(i,t,a){a=a||"info";var e=document.getElementById("gmail-toast");e||((e=document.createElement("div")).id="gmail-toast",e.className="gmail-toast",e.innerHTML='<div class="trow"><div class="ticon"><i class="mdi mdi-bell-outline"></i></div><div style="min-width:0"><div class="tmsg" id="gmail-toast-msg"></div><div class="tsub" id="gmail-toast-sub" style="display:none"></div></div><div class="tclose" title="Tutup">&times;</div></div>',document.body.appendChild(e),e.querySelector(".tclose").addEventListener("click",function(){c()})),e.classList.remove("success","info","warn","error"),e.classList.add(a);var l=e.querySelector(".ticon i");l&&(l.className="mdi "+("success"===a?"mdi-check-circle-outline":"error"===a?"mdi-alert-circle-outline":"warn"===a?"mdi-alert-outline":"mdi-bell-outline"));var n=document.getElementById("gmail-toast-msg"),s=document.getElementById("gmail-toast-sub");n&&(n.textContent=i||""),t?(s.style.display="",s.textContent=t):(s.style.display="none",s.textContent=""),clearTimeout(r),e.style.display="block",requestAnimationFrame(function(){e.classList.add("show")}),r=setTimeout(c,1e4)}function g(i){var a=t("#gmail-loading"),e=t("#gmail-list"),l=t("#gmail-empty");if("loading"===i){a.show(),e.hide(),l.hide();return}if("empty"===i){a.hide(),e.hide(),l.show();return}a.hide(),l.hide(),e.show()}function u(i){o=!!i;var a,e,l=t("#gmail-sync-btn");l.length&&(l.prop("disabled",i),l.find("i").toggleClass("spin",i),l.find(".btn-text").text(i?" Sinkr…":" Refresh Email")),a=i?"Sinkronisasi Gmail…":"Tarik email terbaru & cari cepat",(e=document.getElementById("gmail-subtitle"))&&(e.textContent=a||"Tarik email terbaru & cari cepat")}function f(i){var a,e=t("#gmail-list");if(i=i||[],t("#gmail-count").text(i.length+" email"),!i.length){g("empty");return}e.empty(),i.forEach(function(i){var t="diproses"===i.status?'<span class="badge badge-success">Diproses</span>':"dilihat"===i.status?'<span class="badge badge-secondary">Dilihat</span>':'<span class="badge badge-warning">Baru</span>',a='<button type="button" class="list-group-item list-group-item-action" data-gmail-id="'+(parseInt(i.id,10)||0)+'"><div class="gmail-item__top"><div class="gmail-from">'+m(i.from_email||"-")+'</div><div class="gmail-date">'+m(i.received_at||"")+'</div></div><div class="gmail-subject text-truncate">'+m(i.subject||"(tanpa subject)")+'</div><div class="d-flex align-items-center justify-content-between" style="gap:.5rem"><div class="gmail-snippet text-truncate" style="min-width:0">'+m(i.snippet||"")+'</div><div class="gmail-badge">'+t+"</div></div></button>";e.append(a)}),g("list")}function y(a){a=a||{};var l=(t("#gmail-q").val()||"").trim();return a.silent||g("loading"),t.getJSON(e,{limit:a.limit||20,q:l}).done(function(t){if(!(t&&(!0===t.ok||!0===t.success))){f([]),i.Swal&&Swal.fire(t&&(t.title||"Gagal")||"Gagal",t&&(t.msg||t.pesan)||"Tidak bisa memuat inbox","error");return}f(t.data||[])}).fail(function(t){f([]),i.Swal&&Swal.fire("Error","Koneksi bermasalah saat memuat Gmail","error"),console.error(t&&t.responseText)})}function p(i){i=i||{},o||(u(!0),t.getJSON(l,{limit:i.limit||20}).done(function(t){if(!t||!0!==t.ok){d("Sync gagal","Response tidak valid","error"),console.warn("Sync gagal",t);return}var a=t.sync||null;if(!a||!0!==a.ok){d("Sync error",a&&a.msg?a.msg:"Tidak bisa ambil email","error"),console.warn("Sync error",a);return}var e=a.inserted?parseInt(a.inserted,10):0;e>0?(d("✅ "+e+" email baru masuk",a.last_sync_new?"Last sync: "+a.last_sync_new:"","success"),y({silent:!0,limit:i.limit||20})):d("Tidak ada email baru",a.last_sync_new?"Last sync: "+a.last_sync_new:"","info")}).fail(function(i){d("Sync gagal","Koneksi/Server bermasalah","error"),console.error(i&&i.responseText)}).always(function(){u(!1)}))}function v(){t("#gmail-inbox-modal").modal("show"),y({silent:!1,limit:20}).always(function(){clearTimeout(s),s=setTimeout(function(){p({limit:20})},500)}),setTimeout(function(){try{document.getElementById("gmail-q").focus()}catch(i){}},150)}function b(i){t("#gmail-detail-modal").modal("show"),t("#gmail-detail-body").html('<div class="text-center text-muted py-5">Memuat…</div>');var a=document.getElementById("gmail-detail-subtitle"),e=document.getElementById("gmail-detail-badge");a&&(a.textContent="Memuat isi email…"),e&&(e.textContent="Loading"),t.get(n+i,function(l){t("#gmail-detail-body").html(l),a&&(a.textContent="Email berhasil dimuat"),e&&(e.textContent="OK"),function i(t){var a=document.querySelector('#gmail-list [data-gmail-id="'+t+'"]');if(a){var e=a.querySelector(".gmail-badge");e&&(e.innerHTML='<span class="badge badge-secondary">Dilihat</span>')}}(parseInt(i,10))}).fail(function(i){t("#gmail-detail-body").html('<div class="text-danger">Gagal memuat detail.</div>'),console.error(i&&i.responseText)})}i.gmailOpenInbox=v,v(),i.gmailOpenDetail=b,t("#gmail-inbox-modal").off("hidden.bs.modal.gmail").on("hidden.bs.modal.gmail",function(){clearTimeout(s)}),t(document).off("click.gmail","#gmail-sync-btn").on("click.gmail","#gmail-sync-btn",function(){p({limit:20})}),t(document).off("click.gmail","#gmail-clear").on("click.gmail","#gmail-clear",function(){t("#gmail-q").val(""),y({silent:!1,limit:20});try{document.getElementById("gmail-q").focus()}catch(i){}});var h=null;t(document).off("input.gmail","#gmail-q").on("input.gmail","#gmail-q",function(){clearTimeout(h),h=setTimeout(function(){y({silent:!1,limit:20})},250)}),t(document).off("click.gmail","#gmail-list .list-group-item").on("click.gmail","#gmail-list .list-group-item",function(){var i=t(this).data("gmail-id");i&&b(i)}),v()}}(window,window.jQuery);