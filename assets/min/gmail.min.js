!function(i,a){"use strict";i.gmailInitAndOpen=function(t){if(i.__GMAIL_UI__){i.gmailOpenInbox?i.gmailOpenInbox():a("#gmail-inbox-modal").modal("show");return}i.__GMAIL_UI__=!0;var e=(t=t||i.GMAIL_CFG||{}).URL_LIST||"",l=t.URL_SYNC||"",n=t.URL_DETAIL||"";if(!e||!l||!n){console.error("GMAIL_CFG belum lengkap",t),i.Swal&&Swal.fire("Error","Konfigurasi Gmail belum lengkap.","error");return}var s={page:1,pages:1,limit:10},m=null,o=!1,g=null;function r(i){return(i||"").toString().replace(/[&<>"']/g,function(i){return({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"})[i]})}function c(i){var t=a("#gmail-loading"),e=a("#gmail-list"),l=a("#gmail-empty");if("loading"===i){t.show(),e.hide(),l.hide();return}if("empty"===i){t.hide(),e.hide(),l.show();return}t.hide(),l.hide(),e.show()}function d(){var i=document.getElementById("gmail-toast");i&&(i.classList.remove("show"),clearTimeout(g),g=setTimeout(function(){try{i.style.display="none"}catch(a){}},200))}function p(i,a,t){t=t||"info";var e=document.getElementById("gmail-toast");e||((e=document.createElement("div")).id="gmail-toast",e.className="gmail-toast",e.innerHTML='<div class="trow"><div class="ticon"><i class="mdi mdi-bell-outline"></i></div><div style="min-width:0"><div class="tmsg" id="gmail-toast-msg"></div><div class="tsub" id="gmail-toast-sub" style="display:none"></div></div><div class="tclose" title="Tutup">&times;</div></div>',document.body.appendChild(e),e.querySelector(".tclose").addEventListener("click",d)),e.classList.remove("success","info","warn","error"),e.classList.add(t);var l=document.getElementById("gmail-toast-msg"),n=document.getElementById("gmail-toast-sub");l&&(l.textContent=i||""),a?(n.style.display="",n.textContent=a):(n.style.display="none",n.textContent=""),clearTimeout(g),e.style.display="block",requestAnimationFrame(function(){e.classList.add("show")}),g=setTimeout(d,1e4)}function u(i){o=!!i;var t,e,l=a("#gmail-sync-btn");l.length&&(l.prop("disabled",i),l.find("i").toggleClass("spin",i),l.find(".btn-text").text(i?" Sinkr…":" Refresh Email")),t=i?"Sinkronisasi Gmail…":"Tarik email terbaru & cari cepat",(e=document.getElementById("gmail-subtitle"))&&(e.textContent=t||"Tarik email terbaru & cari cepat")}function f(i){i=i||{},s.page=parseInt(i.page,10)||1,s.pages=parseInt(i.pages,10)||1,s.limit=parseInt(i.limit,10)||s.limit,a("#gmail-page-info").text(s.page+" / "+s.pages);var t=!!i.has_prev||s.page>1,e=!!i.has_next||s.page<s.pages;a("#gmail-prev-page").prop("disabled",!t),a("#gmail-next-page").prop("disabled",!e),null!=i.from&&null!=i.to&&null!=i.filtered?a("#gmail-count").text(i.from+"-"+i.to+" dari "+i.filtered+" email"):a("#gmail-count").text("0 email")}function v(i){var t=a("#gmail-list");if(!(i=i||[]).length){c("empty");return}t.empty(),i.forEach(function(i){var a="diproses"===i.status?'<span class="badge badge-success">Diproses</span>':"dilihat"===i.status?'<span class="badge badge-secondary">Dilihat</span>':'<span class="badge badge-warning">Baru</span>',e=parseInt(i.id,10)||0;t.append('<button type="button" class="list-group-item list-group-item-action" data-gmail-id="'+e+'"><div class="gmail-item__top"><div class="gmail-from">'+r(i.from_email||"-")+'</div><div class="gmail-date">'+r(i.received_at||"")+'</div></div><div class="gmail-subject text-truncate">'+r(i.subject||"(tanpa subject)")+'</div><div class="d-flex align-items-center justify-content-between" style="gap:.5rem"><div class="gmail-snippet text-truncate" style="min-width:0">'+r(i.snippet||"")+'</div><div class="gmail-badge">'+a+"</div></div></button>")}),c("list")}function b(t){t=t||{};var l=(a("#gmail-q").val()||"").trim(),n=null!=t.page?t.page:s.page,m=null!=t.limit?t.limit:s.limit;return t.silent||c("loading"),a.getJSON(e,{limit:m,page:n,q:l}).done(function(a){if(!(a&&(!0===a.ok||!0===a.success))){v([]),f({page:1,pages:1,limit:m,filtered:0,from:0,to:0,has_prev:!1,has_next:!1}),i.Swal&&Swal.fire("Gagal",a&&(a.msg||a.pesan)||"Tidak bisa memuat inbox","error");return}f(a.meta||{}),v(a.data||[])}).fail(function(a){v([]),f({page:1,pages:1,limit:m,filtered:0,from:0,to:0,has_prev:!1,has_next:!1}),i.Swal&&Swal.fire("Error","Koneksi bermasalah saat memuat Gmail","error"),console.error("LIST FAIL:",a&&a.responseText)})}function y(i){i=i||{},o||(u(!0),a.getJSON(l,{limit:i.limit||s.limit}).done(function(i){if(!i||!0!==i.ok){p("Sync gagal","Response tidak valid","error");return}var a=i.sync||null;if(!a||!0!==a.ok){p("Sync error",a&&a.msg?a.msg:"Tidak bisa ambil email","error");return}var t=a.inserted?parseInt(a.inserted,10):0;t>0?(p("✅ "+t+" email baru masuk",a.last_sync_new?"Last sync: "+a.last_sync_new:"","success"),s.page=1,b({silent:!0,page:s.page,limit:s.limit})):p("Tidak ada email baru",a.last_sync_new?"Last sync: "+a.last_sync_new:"","info")}).fail(function(i){p("Sync gagal","Koneksi/Server bermasalah","error"),console.error("SYNC FAIL:",i&&i.responseText)}).always(function(){u(!1)}))}function h(){s.limit=10,s.page=1,a("#gmail-inbox-modal").modal("show"),b({silent:!1,limit:s.limit,page:s.page}).always(function(){clearTimeout(m),m=setTimeout(function(){y({limit:s.limit})},500)}),setTimeout(function(){try{document.getElementById("gmail-q").focus()}catch(i){}},150)}function $(i){a("#gmail-detail-modal").modal("show"),a("#gmail-detail-body").html('<div class="text-center text-muted py-5">Memuat…</div>'),a.get(n+i,function(i){a("#gmail-detail-body").html(i)}).fail(function(i){a("#gmail-detail-body").html('<div class="text-danger">Gagal memuat detail.</div>'),console.error("DETAIL FAIL:",i&&i.responseText)})}i.gmailOpenInbox=h,i.gmailOpenDetail=$,a("#gmail-inbox-modal").off("hidden.bs.modal.gmail").on("hidden.bs.modal.gmail",function(){clearTimeout(m)}),a(document).off("click.gmail","#gmail-sync-btn").on("click.gmail","#gmail-sync-btn",function(){y({limit:s.limit})}),a(document).off("click.gmail","#gmail-clear").on("click.gmail","#gmail-clear",function(){a("#gmail-q").val(""),s.page=1,b({silent:!1,limit:s.limit,page:s.page})}),a(document).off("click.gmail","#gmail-prev-page").on("click.gmail","#gmail-prev-page",function(){s.page>1&&(s.page--,b({silent:!1,limit:s.limit,page:s.page}))}),a(document).off("click.gmail","#gmail-next-page").on("click.gmail","#gmail-next-page",function(){s.page<s.pages&&(s.page++,b({silent:!1,limit:s.limit,page:s.page}))});var _=null;a(document).off("input.gmail","#gmail-q").on("input.gmail","#gmail-q",function(){clearTimeout(_),_=setTimeout(function(){s.page=1,b({silent:!1,limit:s.limit,page:s.page})},250)}),a(document).off("click.gmail","#gmail-list .list-group-item").on("click.gmail","#gmail-list .list-group-item",function(){var i=a(this).data("gmail-id");i&&$(i)}),h()}}(window,window.jQuery);